# Detection script for CVE-2013-3900. This script detects if Certificate Padding Check has been enabled for Windows Installer.

# Define the registry paths and value name
$path1 = "HKLM:\Software\Microsoft\Cryptography\Wintrust\Config"
$path2 = "HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config"
$name = "EnableCertPaddingCheck"
$expectedValue = "1"

# Function to get registry value as string and check type
function Get-RegistryValue {
    param (
        [string]$path,
        [string]$name
    )

    try {
        $value = (Get-ItemProperty -Path $path -Name $name -ErrorAction SilentlyContinue).$name
        $valueType = (Get-ItemProperty -Path $path -ErrorAction SilentlyContinue).PSObject.Properties[$name].TypeNameOfValue
        if ($value -eq $null -or $valueType -ne 'System.String') {
            return $null
        } else {
            return $value.ToString()
        }
    } catch {
        return $null
    }
}

# Get the registry values
$value1 = Get-RegistryValue -path $path1 -name $name
$value2 = Get-RegistryValue -path $path2 -name $name

# Check if both registry values are set to "1" and are of type REG_SZ
if ($value1 -eq $expectedValue -and $value2 -eq $expectedValue) {
    Write-Output "Compliant"
    exit 0
} else {
    Write-Output "Non-compliant"
    exit 1
}
